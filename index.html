<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>ç–¯ç‹‚çŸ¿å·¥ - ç»ˆæè‡ªåŠ¨ç‰ˆ</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Zcool+KuaiLe&display=swap');

        /* æ ¸å¿ƒä¿®å¤ï¼šç»å¯¹å®šä½é“ºæ»¡ï¼Œç¦æ­¢é¡µé¢çº§æ»šåŠ¨ï¼Œè§£å†³å®‰å“åœ°å€æ é—®é¢˜ */
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            overflow: hidden; 
            background-color: #0f172a; /* slate-900 */
            touch-action: manipulation;
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            -webkit-tap-highlight-color: transparent;
        }

        /* æ¸¸æˆå®¹å™¨ï¼šé™åˆ¶æœ€å¤§å®½åº¦ï¼Œå±…ä¸­ï¼Œæ¨¡æ‹ŸAPPä½“éªŒ */
        #game-root {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            flex-direction: column;
            max-width: 480px;
            margin: 0 auto;
            background: linear-gradient(180deg, #1e293b 0%, #0f172a 100%);
            box-shadow: 0 0 40px rgba(0,0,0,0.8);
        }

        /* æ»šåŠ¨åŒºåŸŸ */
        .scroll-area {
            flex: 1;
            overflow-y: auto;
            -webkit-overflow-scrolling: touch;
            padding-bottom: 20px;
        }

        /* --- ç²¾è‡´çš„è§†è§‰æ•ˆæœå›å½’ --- */

        .pixel-font {
            font-family: 'Courier New', Courier, monospace;
            font-weight: 800;
            letter-spacing: -1px;
        }

        /* ç«‹ä½“æ–¹å—æ ·å¼ */
        .mine-block {
            position: relative;
            transform: translateY(0);
            transition: transform 0.1s, filter 0.2s;
            cursor: pointer;
            /* ç«‹ä½“é˜´å½± */
            box-shadow: 0 4px 0 rgba(0,0,0,0.3), inset 0 2px 0 rgba(255,255,255,0.1);
            border-radius: 8px;
        }
        
        .mine-block:active {
            transform: translateY(4px);
            box-shadow: 0 0 0 rgba(0,0,0,0.3), inset 0 2px 0 rgba(0,0,0,0.2);
        }

        .mine-block.mined {
            transform: translateY(4px);
            box-shadow: inset 0 2px 4px rgba(0,0,0,0.5);
            cursor: default;
            border: 1px solid #334155;
        }

        /* åŠ¨ç”»å…³é”®å¸§ */
        @keyframes pop {
            0% { transform: scale(0.5); opacity: 0; }
            60% { transform: scale(1.2); }
            100% { transform: scale(1); opacity: 1; }
        }
        .pop-anim { animation: pop 0.4s cubic-bezier(0.34, 1.56, 0.64, 1); }
        
        @keyframes floatText {
            0% { transform: translateY(0) scale(1); opacity: 1; }
            100% { transform: translateY(-50px) scale(1.2); opacity: 0; }
        }
        .float-text {
            position: absolute;
            pointer-events: none;
            animation: floatText 0.8s ease-out forwards;
            font-weight: 900;
            text-shadow: 2px 2px 0 rgba(0,0,0,0.8);
            z-index: 100;
            white-space: nowrap;
        }

        @keyframes shine {
            0% { background-position: -200% center; }
            100% { background-position: 200% center; }
        }
        .shine-effect {
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            background-size: 200% 100%;
            animation: shine 2s infinite;
        }

        /* è‡ªåŠ¨é‡‡çŸ¿æœºå·¥ä½œæ—¶çš„åŠ¨ç”» */
        @keyframes auto-dig {
            0%, 100% { transform: rotate(0deg) scale(1); }
            50% { transform: rotate(-15deg) scale(1.1); }
        }
        .auto-working {
            animation: auto-dig 0.5s infinite;
            color: #4ade80; /* green-400 */
        }

        /* éšè—æ»šåŠ¨æ¡ä½†å…è®¸æ»šåŠ¨ */
        .no-scrollbar::-webkit-scrollbar {
            display: none;
        }
        .no-scrollbar {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }
    </style>
</head>
<body>

    <div id="game-root">
        <!-- é¡¶éƒ¨æ ï¼šåŒ…å«çŠ¶æ€å’Œé‡‘å¸ -->
        <header class="flex-none bg-slate-800/90 backdrop-blur-md border-b border-slate-700 p-4 z-20 shadow-lg flex justify-between items-center h-20">
            <div class="flex flex-col gap-1">
                <h1 class="text-xl font-black text-transparent bg-clip-text bg-gradient-to-r from-yellow-400 to-orange-500 drop-shadow-sm tracking-wide">
                    ğŸš§ ç–¯ç‹‚çŸ¿å·¥
                </h1>
                <div class="flex items-center gap-2 text-xs text-slate-400 bg-slate-900/50 px-2 py-1 rounded-full border border-slate-700 w-fit">
                    <span id="tool-icon" class="text-base">â›ï¸</span>
                    <span id="tool-name">é”ˆé“é•</span>
                    <span id="auto-tag" class="hidden text-green-400 font-bold ml-1 animate-pulse">AUTO</span>
                </div>
            </div>
            
            <div class="bg-black/40 px-4 py-2 rounded-xl border border-slate-600 text-right shadow-inner min-w-[100px]">
                <div class="text-[10px] text-slate-500 uppercase font-bold tracking-wider mb-0.5">æˆ‘çš„èµ„äº§</div>
                <div class="text-2xl font-bold text-yellow-300 pixel-font leading-none flex items-center justify-end gap-1">
                    <span id="gold-display">0</span>
                    <span class="text-lg">ğŸ’°</span>
                </div>
            </div>
        </header>

        <!-- ä¸­é—´æ¸¸æˆåŒºï¼šè‡ªé€‚åº”é«˜åº¦ -->
        <main class="scroll-area relative p-4 flex flex-col gap-5 no-scrollbar">
            
            <!-- èƒ½é‡/çŠ¶æ€æ¡ -->
            <div class="sticky top-0 z-10 bg-gradient-to-b from-[#1e293b] to-transparent pb-4 pt-1">
                <div class="flex justify-between items-end mb-1 px-1">
                    <span id="status-text" class="text-xs font-mono text-slate-400">å‡†å¤‡å°±ç»ª...</span>
                    <span class="text-[10px] text-slate-500" id="luck-display">LUCK: 0%</span>
                </div>
                <div class="h-3 w-full bg-slate-900 rounded-full overflow-hidden border border-slate-700 shadow-inner">
                    <div id="stamina-bar" class="h-full bg-gradient-to-r from-blue-500 to-cyan-400 w-full transition-all duration-100 shadow-[0_0_10px_rgba(59,130,246,0.5)]"></div>
                </div>
            </div>

            <!-- æŒ–çŸ¿ç½‘æ ¼ (ç²¾è‡´ç‰ˆ) -->
            <div id="grid-container" class="grid grid-cols-5 gap-2.5 mx-auto w-full max-w-[380px] select-none touch-manipulation">
                <!-- JSç”Ÿæˆ -->
            </div>

            <!-- èƒŒåŒ…å±•ç¤º (ç²¾è‡´ç‰ˆ) -->
            <div class="bg-slate-800/80 rounded-xl p-3 border border-slate-700 shadow-lg mt-2">
                <div class="flex justify-between items-center mb-2 border-b border-slate-700/50 pb-2">
                    <span class="text-xs text-slate-400 font-bold uppercase tracking-widest flex items-center gap-1">
                        ğŸ’ èƒŒåŒ…ç‰©å“
                    </span>
                    <span id="bag-count" class="text-[10px] bg-slate-700 text-slate-300 px-2 py-0.5 rounded-full">0/âˆ</span>
                </div>
                <div id="inventory-list" class="flex flex-wrap gap-1.5 min-h-[40px] max-h-[120px] overflow-y-auto no-scrollbar content-start">
                    <div class="w-full text-center py-2 text-slate-600 text-xs italic">ç©ºç©ºå¦‚ä¹Ÿ...</div>
                </div>
            </div>
            
            <!-- åº•éƒ¨å ä½ï¼Œé˜²æ­¢å†…å®¹è¢«æŒ‰é’®é®æŒ¡ -->
            <div class="h-24"></div>
        </main>

        <!-- åº•éƒ¨æ“ä½œæ ï¼šå®Œç¾é˜²é®æŒ¡ -->
        <footer class="flex-none bg-slate-800 border-t border-slate-700 p-4 z-30 shadow-[0_-4px_20px_rgba(0,0,0,0.4)] pb-[calc(1rem+env(safe-area-inset-bottom))]">
            <div class="grid grid-cols-2 gap-4 h-16">
                <!-- å‡ºå”®æŒ‰é’® -->
                <button onclick="sellAll()" id="btn-sell" class="group relative bg-slate-700 rounded-2xl flex flex-col items-center justify-center text-slate-200 transition-all active:scale-95 border-b-4 border-slate-900 active:border-b-0 active:translate-y-1 overflow-hidden">
                    <div class="font-bold text-base flex items-center gap-2 z-10">
                        <span>ğŸ’° ä¸€é”®å‡ºå”®</span>
                    </div>
                    <div id="sell-value" class="text-xs text-slate-400 z-10 group-hover:text-green-300 transition-colors mt-0.5">å½“å‰ä»·å€¼: 0</div>
                    <!-- è¿›åº¦æ¡èƒŒæ™¯ -->
                    <div id="sell-bg" class="absolute bottom-0 left-0 h-1 w-0 bg-green-500 transition-all duration-300"></div>
                </button>
                
                <!-- å•†åº—æŒ‰é’® -->
                <button onclick="toggleShop()" class="relative bg-blue-600 hover:bg-blue-500 rounded-2xl flex flex-col items-center justify-center text-white transition-all active:scale-95 border-b-4 border-blue-800 active:border-b-0 active:translate-y-1">
                    <span class="font-black text-lg tracking-wide z-10 flex items-center gap-2">
                        ğŸ›’ å‡çº§å·¥å…·
                        <span id="shop-badge" class="hidden w-3 h-3 bg-red-500 rounded-full border-2 border-white animate-bounce absolute top-3 right-3"></span>
                    </span>
                    <span class="text-[10px] text-blue-200 opacity-80 z-10" id="next-upgrade-hint">æå‡æ•ˆç‡</span>
                    <div class="absolute inset-0 bg-gradient-to-t from-black/20 to-transparent rounded-2xl"></div>
                </button>
            </div>
        </footer>

        <!-- æµ®åŠ¨ç‰¹æ•ˆå±‚ -->
        <div id="fx-layer" class="absolute inset-0 pointer-events-none overflow-hidden z-50"></div>

        <!-- å•†åº—æ¨¡æ€æ¡† (ç²¾è‡´å¼¹çª—) -->
        <div id="shop-modal" class="absolute inset-0 bg-black/80 backdrop-blur-sm z-40 hidden flex flex-col justify-end sm:justify-center opacity-0 transition-opacity duration-300">
            <div class="bg-slate-800 w-full sm:max-w-sm sm:rounded-2xl mx-auto flex flex-col max-h-[85vh] shadow-2xl transform transition-transform duration-300 translate-y-full sm:translate-y-10" id="shop-content">
                
                <!-- å¼¹çª—å¤´éƒ¨ -->
                <div class="p-5 border-b border-slate-700 flex justify-between items-center bg-slate-800 sm:rounded-t-2xl">
                    <div>
                        <h2 class="text-xl font-black text-white flex items-center gap-2">
                            âš’ï¸ è£…å¤‡é»‘å¸‚
                        </h2>
                        <p class="text-xs text-slate-400 mt-1">è¶Šé«˜çº§çš„å·¥å…·ï¼ŒæŒ–åˆ°å®è´çš„æ¦‚ç‡è¶Šå¤§</p>
                    </div>
                    <button onclick="toggleShop()" class="bg-slate-700 hover:bg-slate-600 w-8 h-8 rounded-full flex items-center justify-center text-slate-300 transition-colors">âœ•</button>
                </div>

                <!-- å•†å“åˆ—è¡¨ -->
                <div id="shop-items" class="p-4 overflow-y-auto space-y-3 pb-safe">
                    <!-- JSç”Ÿæˆ -->
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆæ•°æ®é…ç½® (ä¿ç•™åŸç‰ˆå·¥å…· + æ–°å¢è‡ªåŠ¨æœº) ---
        
        const TOOLS = [
            { id: 0, name: "é”ˆé“é•", cost: 0, power: 1, luck: 0, cooldown: 800, icon: "â›ï¸", desc: "æ–°æ‰‹å…¥é—¨ï¼Œå‹‰å¼ºèƒ½ç”¨" },
            { id: 1, name: "é“é•", cost: 100, power: 2, luck: 0.1, cooldown: 600, icon: "âš’ï¸", desc: "æ•ˆç‡æå‡ï¼Œç¨å¾®é¡ºæ‰‹" },
            { id: 2, name: "é»„é‡‘é•", cost: 500, power: 3, luck: 0.25, cooldown: 500, icon: "ğŸ”±", desc: "å°Šè´µè±¡å¾ï¼Œè¿æ°”åŠ æˆ" },
            { id: 3, name: "é’»çŸ³é’»å¤´", cost: 2000, power: 5, luck: 0.4, cooldown: 300, icon: "ğŸ’ ", desc: "å‰Šé“å¦‚æ³¥ï¼Œæé€ŸæŒ–æ˜" },
            { id: 4, name: "æ¿€å…‰åˆ‡å‰²æœº", cost: 10000, power: 10, luck: 0.6, cooldown: 100, icon: "ğŸ”«", desc: "é«˜ç§‘æŠ€ï¼Œç–¯ç‹‚å‡ºè´§" },
            { id: 5, name: "å…¨è‡ªåŠ¨é‡‡çŸ¿æœº", cost: 30000, power: 10, luck: 0.7, cooldown: 1000, icon: "ğŸ¤–", desc: "è§£æ”¾åŒæ‰‹ï¼Œè‡ªåŠ¨æŒ‚æœºï¼", auto: true }
        ];

        // æ‰è½ç‰©é…ç½® (ä¿ç•™åŸç‰ˆæƒŠå–œ)
        const LOOT = [
            { id: 'dirt', name: 'ç¢åœŸ', val: 0, w: 45, color: '#5D4037', icon: 'ğŸŒ«ï¸', luckFactor: -2 },
            { id: 'stone', name: 'çŸ³å¤´', val: 2, w: 30, color: '#94a3b8', icon: 'ğŸª¨', luckFactor: -1 },
            { id: 'coal', name: 'ç…¤ç‚­', val: 5, w: 15, color: '#1e293b', icon: 'âš«', luckFactor: 0.5 },
            { id: 'iron', name: 'é“çŸ¿', val: 15, w: 10, color: '#a8a29e', icon: 'ğŸ§±', luckFactor: 1 },
            { id: 'gold', name: 'é‡‘çŸ¿', val: 50, w: 4, color: '#fbbf24', icon: 'ğŸŸ¡', luckFactor: 1.5 },
            { id: 'diamond', name: 'é’»çŸ³', val: 200, w: 1, color: '#22d3ee', icon: 'ğŸ’', luckFactor: 2 },
            { id: 'bomb', name: 'ç‚¸å¼¹', val: -1, w: 5, color: '#ef4444', icon: 'ğŸ’£', luckFactor: -1.5 }, 
            { id: 'chest', name: 'ç¥ç§˜å®ç®±', val: 0, w: 2, color: '#d946ef', icon: 'ğŸ', luckFactor: 1 }
        ];

        // --- æ¸¸æˆçŠ¶æ€ ---
        
        let state = {
            gold: 0,
            toolIdx: 0, // åˆå§‹å·¥å…·ç´¢å¼•
            bag: [],
            gridSize: 25,
            stunned: false, // æ˜¯å¦è¢«æ™•çœ©
            canMine: true,
            autoMining: false // æ˜¯å¦å¼€å¯è‡ªåŠ¨
        };

        // --- åˆå§‹åŒ–ä¸è‡ªåŠ¨æŒ–æ˜å¾ªç¯ ---

        function init() {
            renderGrid();
            updateUI();
            
            // è‡ªåŠ¨æŒ–æ˜é€»è¾‘
            setInterval(() => {
                if (state.autoMining && !state.stunned) {
                    const blocks = Array.from(document.querySelectorAll('.mine-block:not(.mined)'));
                    if (blocks.length > 0) {
                        // éšæœºæŒ‘ä¸€ä¸ªæŒ–
                        const randomBlock = blocks[Math.floor(Math.random() * blocks.length)];
                        const idx = parseInt(randomBlock.dataset.idx);
                        
                        // è‡ªåŠ¨æŒ–æ˜æ—¶ä¸éœ€è¦ç‚¹å‡»åæ ‡ï¼Œä¼ å…¥ null
                        triggerMine(idx, randomBlock, null, null);
                        
                        // è§†è§‰åé¦ˆï¼šå·¥å…·å›¾æ ‡åŠ¨ä¸€ä¸‹
                        const icon = document.getElementById('tool-icon');
                        icon.classList.add('auto-working');
                        setTimeout(() => icon.classList.remove('auto-working'), 200);
                    }
                }
            }, 600); // è‡ªåŠ¨æŒ–æ˜é€Ÿåº¦ï¼š600msä¸€æ¬¡
        }

        // --- æ ¸å¿ƒæ¸¸æˆé€»è¾‘ ---

        function renderGrid() {
            const grid = document.getElementById('grid-container');
            grid.innerHTML = '';
            for(let i=0; i<state.gridSize; i++) {
                const div = document.createElement('div');
                // ä¸¤ç§åœŸå—é¢œè‰²äº¤æ›¿ï¼Œæ›´åƒæ¸¸æˆ
                const bgType = Math.random() > 0.4 ? 'bg-[#78350f]' : 'bg-[#92400e]'; // amber-900 / amber-800
                
                div.className = `mine-block ${bgType} h-14 rounded-lg border-b-4 border-[#451a03] flex items-center justify-center text-xl overflow-hidden`;
                div.dataset.idx = i;
                // åŠ ä¸ªå°åœ†ç‚¹è£…é¥°
                div.innerHTML = '<span class="opacity-10 text-black text-[10px] select-none">â—</span>'; 
                
                div.onclick = (e) => userMine(i, e);
                grid.appendChild(div);
            }
        }

        function userMine(idx, e) {
            // æ‰‹åŠ¨ç‚¹å‡»æŒ–æ˜
            const block = document.getElementById('grid-container').children[idx];
            triggerMine(idx, block, e.clientX, e.clientY);
        }

        function triggerMine(idx, block, clientX, clientY) {
            // çŠ¶æ€æ£€æŸ¥
            if(state.stunned) {
                if (clientX) showFloat(clientX, clientY, "æ™•çœ©ä¸­...", "text-red-500 font-bold");
                return;
            }
            if(!state.canMine && !state.autoMining) return; // è‡ªåŠ¨æŒ–æ˜æ— è§†æ™®é€šå†·å´ï¼Œæœ‰è‡ªå·±çš„é—´éš”
            if(block.classList.contains('mined')) return;

            const tool = TOOLS[state.toolIdx];

            // å†·å´æ¡åŠ¨ç”» (ä»…æ‰‹åŠ¨æŒ–æ˜æ—¶è§¦å‘å†·å´é™åˆ¶)
            if (!state.autoMining) {
                state.canMine = false;
                const bar = document.getElementById('stamina-bar');
                bar.style.width = '0%';
                setTimeout(() => {
                    state.canMine = true;
                    bar.style.width = '100%';
                }, tool.cooldown);
            }

            // è®¡ç®—æ‰è½
            const loot = calculateLoot(tool.luck);
            
            // æ”¹å˜æ–¹å—æ ·å¼
            block.classList.add('mined', 'bg-slate-800', 'border-slate-700');
            block.classList.remove('bg-[#78350f]', 'bg-[#92400e]', 'border-b-4', 'border-[#451a03]');
            block.style.boxShadow = `inset 0 0 15px ${loot.color}22`; // å¾®å¼±å‘å…‰
            block.innerHTML = `<span class="pop-anim drop-shadow-md text-2xl">${loot.icon}</span>`;

            // ç¡®å®šæµ®åŠ¨æ–‡å­—ä½ç½®
            let x = clientX, y = clientY;
            if (!x) { // å¦‚æœæ˜¯è‡ªåŠ¨æŒ–æ˜ï¼Œæˆ–è€…åæ ‡è·å–å¤±è´¥ï¼Œå–æ–¹å—ä¸­å¿ƒ
                const rect = block.getBoundingClientRect();
                x = rect.left + rect.width / 2;
                y = rect.top + rect.height / 2;
            }

            // å¤„ç†ç‰©å“é€»è¾‘
            handleLootEffect(loot, x, y);

            // æ£€æŸ¥æ˜¯å¦æŒ–ç©º
            checkReset(x, y);
        }

        function calculateLoot(luck) {
            let totalWeight = 0;
            // åŠ¨æ€æƒé‡è®¡ç®—
            const weightedPool = LOOT.map(item => {
                let w = item.w;
                // è¿æ°”å¥½ï¼Œå¥½ä¸œè¥¿æƒé‡åŠ å€ï¼Œåä¸œè¥¿æƒé‡å‡åŠ
                if (item.luckFactor > 0) w = w * (1 + luck * item.luckFactor);
                if (item.luckFactor < 0) w = w / (1 + luck * Math.abs(item.luckFactor));
                totalWeight += w;
                return { ...item, finalWeight: w };
            });

            let r = Math.random() * totalWeight;
            for(let item of weightedPool) {
                if(r < item.finalWeight) return item;
                r -= item.finalWeight;
            }
            return LOOT[0];
        }

        function handleLootEffect(loot, x, y) {
            if (loot.id === 'bomb') {
                // ç‚¸å¼¹é€»è¾‘
                state.stunned = true;
                const lost = Math.floor(Math.max(10, state.gold * 0.15)); // æ‰£15%
                state.gold = Math.max(0, state.gold - lost);
                
                showFloat(x, y, `ğŸ’¥ BOOM!`, "text-red-500 text-3xl font-black");
                showFloat(x, y - 30, `-${lost} ğŸ’°`, "text-red-400 text-xl font-bold");
                
                // å±å¹•éœ‡åŠ¨
                document.getElementById('game-root').style.transform = "translate(2px, 2px)";
                setTimeout(() => document.getElementById('game-root').style.transform = "translate(-2px, -2px)", 50);
                setTimeout(() => document.getElementById('game-root').style.transform = "none", 100);

                // çŠ¶æ€æ å˜çº¢
                const status = document.getElementById('status-text');
                status.innerText = "ğŸ˜µ è¢«ç‚¸æ™•äº†ï¼";
                status.className = "text-xs font-bold text-red-500 animate-pulse";
                document.getElementById('stamina-bar').classList.remove('from-blue-500', 'to-cyan-400');
                document.getElementById('stamina-bar').classList.add('bg-red-600');

                setTimeout(() => {
                    state.stunned = false;
                    status.innerText = "å‡†å¤‡å°±ç»ª...";
                    status.className = "text-xs font-mono text-slate-400";
                    document.getElementById('stamina-bar').classList.add('from-blue-500', 'to-cyan-400');
                    document.getElementById('stamina-bar').classList.remove('bg-red-600');
                }, 2000);
            
            } else if (loot.id === 'chest') {
                // å®ç®±é€»è¾‘
                const bonus = Math.floor(Math.random() * 300) + 150 + (state.toolIdx * 50);
                state.gold += bonus;
                showFloat(x, y, `ğŸ +${bonus}ğŸ’°`, "text-fuchsia-400 text-2xl font-bold");
                checkShopState();
            
            } else if (loot.id === 'dirt') {
                // å°˜åœŸ
                showFloat(x, y, "...", "text-slate-600 text-sm");
            
            } else {
                // çŸ¿çŸ³
                state.bag.push(loot);
                showFloat(x, y, `+${loot.name}`, "text-white font-bold", loot.color);
                updateBagUI();
            }
            updateGoldUI();
        }

        function checkReset(x, y) {
            const remaining = document.querySelectorAll('.mine-block:not(.mined)').length;
            if (remaining === 0) {
                showFloat(window.innerWidth / 2, window.innerHeight / 2, "è¿›å…¥ä¸‹ä¸€å±‚...", "text-yellow-400 text-2xl font-bold");
                setTimeout(renderGrid, 800);
            }
        }

        // --- ç»æµç³»ç»Ÿ ---

        function sellAll() {
            if (state.bag.length === 0) return;

            let total = state.bag.reduce((sum, item) => sum + item.val, 0);
            state.gold += total;
            const count = state.bag.length;
            state.bag = [];

            // æ’­æ”¾é‡‘å¸éŸ³æ•ˆçš„è§†è§‰æ›¿ä»£
            const btn = document.getElementById('btn-sell');
            btn.classList.add('scale-105', 'bg-green-600');
            setTimeout(() => btn.classList.remove('scale-105', 'bg-green-600'), 150);

            showFloat(window.innerWidth / 2, window.innerHeight - 150, `+${total} ğŸ’°`, "text-yellow-300 text-4xl font-black drop-shadow-md");
            
            updateGoldUI();
            updateBagUI();
            checkShopState();
        }

        function buyTool(index) {
            const tool = TOOLS[index];
            if (state.gold >= tool.cost) {
                state.gold -= tool.cost;
                state.toolIdx = index;
                
                if (tool.auto) {
                    state.autoMining = true;
                    showFloat(window.innerWidth/2, window.innerHeight/2, "è‡ªåŠ¨æœºå·²å¯åŠ¨ï¼", "text-green-400 text-3xl font-black");
                } else {
                    showFloat(window.innerWidth/2, window.innerHeight/2, "å‡çº§æˆåŠŸï¼", "text-blue-400 text-3xl font-black");
                }

                toggleShop();
                updateUI();
                renderShopItems(); // åˆ·æ–°å•†åº—çŠ¶æ€
            }
        }

        // --- UI æ›´æ–° ---

        function updateUI() {
            updateGoldUI();
            updateBagUI();
            
            const tool = TOOLS[state.toolIdx];
            document.getElementById('tool-name').innerText = tool.name;
            document.getElementById('tool-icon').innerText = tool.icon;
            document.getElementById('luck-display').innerText = `LUCK: ${(tool.luck * 100).toFixed(0)}%`;

            if (state.autoMining) {
                document.getElementById('auto-tag').classList.remove('hidden');
            }
            
            checkShopState();
        }

        function updateGoldUI() {
            document.getElementById('gold-display').innerText = state.gold;
        }

        function updateBagUI() {
            const list = document.getElementById('inventory-list');
            const count = document.getElementById('bag-count');
            const sellVal = document.getElementById('sell-value');
            const sellBtn = document.getElementById('btn-sell');
            const sellBg = document.getElementById('sell-bg');

            count.innerText = `${state.bag.length}`;
            
            let totalVal = state.bag.reduce((sum, i) => sum + i.val, 0);
            sellVal.innerText = `å½“å‰ä»·å€¼: ${totalVal}`;

            if (state.bag.length > 0) {
                sellBtn.classList.add('border-green-800', 'bg-slate-700'); // æ¿€æ´»çŠ¶æ€é¢œè‰²
                sellBtn.classList.remove('border-slate-900');
                sellVal.classList.add('text-green-300');
                sellBg.style.width = '100%'; // è¿›åº¦æ¡æ»¡
                
                // æ¸²æŸ“èƒŒåŒ…ç‰©å“ï¼ˆå€’åºæ˜¾ç¤ºæœ€æ–°çš„ï¼‰
                const displayItems = state.bag.slice().reverse().slice(0, 15);
                list.innerHTML = displayItems.map(i => 
                    `<div class="w-8 h-8 bg-slate-700 rounded flex items-center justify-center text-lg border border-slate-600 shadow-sm" style="border-color:${i.color}44">${i.icon}</div>`
                ).join('');
                if(state.bag.length > 15) list.innerHTML += `<div class="text-xs text-slate-500 py-2">...</div>`;

            } else {
                sellBtn.classList.remove('border-green-800', 'bg-green-900');
                sellBtn.classList.add('border-slate-900');
                sellVal.classList.remove('text-green-300');
                sellBg.style.width = '0%';
                list.innerHTML = `<div class="w-full text-center py-2 text-slate-600 text-xs italic">ç©ºç©ºå¦‚ä¹Ÿ...</div>`;
            }
        }

        function checkShopState() {
            const nextIdx = state.toolIdx + 1;
            const badge = document.getElementById('shop-badge');
            const hint = document.getElementById('next-upgrade-hint');
            
            if (nextIdx < TOOLS.length) {
                const nextTool = TOOLS[nextIdx];
                if (state.gold >= nextTool.cost) {
                    badge.classList.remove('hidden');
                    hint.innerText = "âœ¨ å¯è´­ä¹°æ–°è£…å¤‡!";
                    hint.className = "text-[10px] text-yellow-300 font-bold animate-pulse z-10";
                } else {
                    badge.classList.add('hidden');
                    hint.innerText = `ä¸‹çº§: ${nextTool.name}`;
                    hint.className = "text-[10px] text-blue-200 opacity-60 z-10";
                }
            } else {
                badge.classList.add('hidden');
                hint.innerText = "å·²é¡¶çº§";
                hint.className = "text-[10px] text-green-300 font-bold z-10";
            }
        }

        function showFloat(x, y, text, classes, color) {
            const el = document.createElement('div');
            el.className = `float-text ${classes}`;
            el.innerText = text;
            if (color) el.style.color = color;
            
            // è¾¹ç•Œä¿æŠ¤
            const safeX = Math.min(Math.max(20, x), window.innerWidth - 80);
            const safeY = Math.min(Math.max(60, y), window.innerHeight - 60);

            el.style.left = `${safeX}px`;
            el.style.top = `${safeY}px`;
            
            document.getElementById('fx-layer').appendChild(el);
            setTimeout(() => el.remove(), 1000);
        }

        // --- å•†åº—ç•Œé¢ ---

        function toggleShop() {
            const modal = document.getElementById('shop-modal');
            const content = document.getElementById('shop-content');
            
            if (modal.classList.contains('hidden')) {
                renderShopItems();
                modal.classList.remove('hidden');
                // åŠ¨ç”»
                requestAnimationFrame(() => {
                    modal.classList.remove('opacity-0');
                    content.classList.remove('translate-y-full');
                });
            } else {
                modal.classList.add('opacity-0');
                content.classList.add('translate-y-full');
                setTimeout(() => modal.classList.add('hidden'), 300);
            }
        }

        function renderShopItems() {
            const container = document.getElementById('shop-items');
            container.innerHTML = '';

            TOOLS.forEach((tool, index) => {
                if (index === 0) return; // ä¸æ˜¾ç¤ºç”Ÿé”ˆé“²

                const isOwned = state.toolIdx >= index;
                const isUnlockable = state.toolIdx === index - 1;
                const canAfford = state.gold >= tool.cost;

                let btnHTML = '';
                let cardClass = 'bg-slate-700/50 border-slate-600 opacity-60'; // é»˜è®¤é”å®šçŠ¶æ€

                if (isOwned) {
                    cardClass = 'bg-slate-700 border-slate-600';
                    btnHTML = `<button class="px-3 py-1.5 rounded-lg bg-slate-600 text-slate-400 text-xs font-bold cursor-default border border-slate-500">å·²æ‹¥æœ‰</button>`;
                } else if (isUnlockable) {
                    cardClass = 'bg-slate-700 border-slate-500';
                    if (canAfford) {
                        // å¯è´­ä¹°é«˜äº®çŠ¶æ€
                        cardClass = 'bg-gradient-to-r from-slate-700 to-blue-900/30 border-blue-500 shadow-blue-900/20 shadow-lg';
                        btnHTML = `
                            <button onclick="buyTool(${index})" class="px-4 py-2 rounded-lg bg-yellow-500 hover:bg-yellow-400 text-black text-sm font-black shadow-lg transform active:scale-95 transition-all animate-pulse">
                                è´­ä¹° ${tool.cost}
                            </button>`;
                    } else {
                        btnHTML = `<button class="px-3 py-1.5 rounded-lg bg-slate-800 text-slate-500 text-xs font-bold border border-slate-600">å·® ${tool.cost - state.gold}</button>`;
                    }
                }

                // ç‰¹æ®Šå¤„ç†è‡ªåŠ¨æœº
                if (tool.auto && isUnlockable) {
                    cardClass += ' border-purple-500 shadow-purple-900/30';
                }

                container.innerHTML += `
                    <div class="flex items-center justify-between p-3 rounded-xl border ${cardClass} transition-all">
                        <div class="flex items-center gap-4">
                            <div class="w-12 h-12 rounded-lg bg-slate-800 flex items-center justify-center text-3xl shadow-inner border border-slate-600/50">
                                ${tool.icon}
                            </div>
                            <div class="flex flex-col">
                                <span class="font-bold text-slate-200 text-sm flex items-center gap-2">
                                    ${tool.name}
                                    ${tool.auto ? '<span class="text-[10px] bg-purple-600 text-white px-1.5 py-0.5 rounded uppercase">Ultra</span>' : ''}
                                </span>
                                <span class="text-[10px] text-slate-400 mt-0.5">${tool.desc}</span>
                                ${!tool.auto ? `<span class="text-[10px] text-blue-400 mt-0.5">Lucky +${(tool.luck*100).toFixed(0)}%</span>` : ''}
                            </div>
                        </div>
                        <div>${btnHTML}</div>
                    </div>
                `;
            });
        }

        init();
    </script>
</body>
</html>